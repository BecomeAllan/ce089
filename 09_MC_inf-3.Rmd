---
title: "Métodos de Monte Carlo em inferência estatística"
subtitle: "Testes de hipótese de Monte Carlo"
author: "Fernando P. Mayer"
bibliography: ref.bib
output:
  html_document:
    number_sections: true
    toc_depth: 3
---

```{r, cache=FALSE, include=FALSE}
source("setup_knitr.R")
opts_chunk$set(fig.path = "figures/09_MC_inf-3/")
```

# Introdução


## Nível descritivo {-}

- Em geral, $\alpha$ é pré-fixado para construir a regra de decisão.
- Uma alternativa é deixar em aberto a escolha de $\alpha$ para quem for
tomar a decisão.
- A ideia é calcular, **supondo que a hipóese nula é verdadeira**, a
probabilidade de se obter estimativas mais extremas do que aquela
fornecida pela amostra.
- Essa probabilidade é chamada de **nível descritivo**, denotada por
$\alpha^*$ (ou $P$-valor).
- Valores pequenos de $\alpha^*$ evidenciam que a hipótese nula é falsa.
- O conceito de "pequeno" fica para quem decide qual $\alpha$ deve usar
para comparar com $\alpha^*$.

Para **testes unilaterais**, sendo $H_0: \mu = \mu_0$, a expressão de
$\alpha^*$ depende da hipótese alternativa:

\begin{align*}
\alpha^* &= P(\bar{X} < \bar{x}_{obs} \, | \, H_0 \text{ verdadeira}) \quad
\text{para } H_a: \mu < \mu_0 \\
\alpha^* &= P(\bar{X} > \bar{x}_{obs} \, | \, H_0 \text{ verdadeira}) \quad
\text{para } H_a: \mu > \mu_0
\end{align*}

Para **testes bilaterais**, temos $H_0: \mu = \mu_0$ contra $H_0: \mu
\neq \mu_0$, a definição do nível descritivo depende da relação entre
$\bar{x}_{obs}$ e $\mu_0$:

\begin{align*}
\alpha^* &= 2 \times P(\bar{X} < \bar{x}_{obs} \, | \, H_0 \text{
verdadeira}) \quad \text{se }  \bar{x}_{obs} < \mu_0 \\
\alpha^* &= 2 \times P(\bar{X} > \bar{x}_{obs} \, | \, H_0 \text{
verdadeira}) \quad \text{se }  \bar{x}_{obs} > \mu_0 \\
\end{align*}

Como estamos calculando a probabilidade para apenas uma das caudas,
então esse valor é multiplicado por 2.

## TH para a média

```{r}
## Com variancia conhecida ---------------------------------------------
set.seed(2019-10-29)
n <- 300
x <- rnorm(n, 10, 1)
hist(x)
(med <- mean(x))
(s2 <- var(x))

t.test(x = x, alternative = "two.sided", mu = 10)
mu0 <- 10

(zcalc <- (med - mu0)/sqrt(1/n))
(zcrit <- qnorm(.025, mean = 0, sd = 1))
pnorm(zcalc, mean = 0, sd = 1, lower.tail = FALSE)
2 * pnorm(zcalc, mean = 0, sd = 1, lower.tail = FALSE)
t.test(x = x, alternative = "two.sided", mu = 10)

calc.med <- function(x) {
    mean(x)
}

N <- 10000
am <- replicate(N, calc.med(rnorm(n, 10, 1)))
## am <- rnorm(N, mean = mu0, sd = 1/sqrt(n))
hist(am)
abline(v = med, col = 2)

2 * sum(am >= med)/N
2 * sum(am > med)/N

## Padroniza a distribuição das propoções amostrais
tt <- (am - mu0)/sqrt(1/n)
hist(tt, freq = FALSE)
abline(v = zcalc, col = 2)

## Proporcao da amostra abaixo de theta0 ~ "p-valor"
2 * sum(tt >= zcalc)/N


## COm variancia desconhecida ------------------------------------------
set.seed(2019-10-29)
n <- 30
x <- rnorm(n, 10, 1)
hist(x)
(med <- mean(x))
(s2 <- var(x))

t.test(x = x, alternative = "two.sided", mu = 10)
mu0 <- 10

(tcalc <- (med - mu0)/sqrt(s2/n))
(tcrit <- qt(.025, df = n - 1))
2 * pt(tcalc, df = n - 1, lower.tail = FALSE)

N <- 10000
am <- replicate(N, calc.med(rnorm(n, 10, sqrt(s2))))
## am <- rnorm(N, mean = mu0, sd = sqrt(s2/n))
hist(am)

2 * sum(am >= med)/N

## Padroniza a distribuição das propoções amostrais
tt <- (am - mu0)/sqrt(s2/n)
hist(tt, freq = FALSE)
abline(v = tcalc, col = 2)

## Proporcao da amostra abaixo de theta0 ~ "p-valor"
2 * sum(tt >= tcalc)/N
```

## Comparação de duas médias

```{r}
## Comparacao de duas medias - exemplo do Manly
machos <- c(120, 107, 110, 116, 114, 111, 113, 117, 114, 112)
femeas <- c(110, 111, 107, 108, 110, 105, 107, 106, 111, 111)
da <- data.frame(comp = c(machos, femeas),
                 sexo = c(rep("M", 10), rep("F", 10)))
densityplot(~comp, groups = sexo, data = da, auto.key = TRUE)
tapply(da$comp, da$sexo, mean)
diff(tapply(da$comp, da$sexo, mean))
sd(machos)

(m1 <- mean(machos))
(m2 <- mean(femeas))

(med.amostral <- m1 - m2)

n1 <- length(machos)
v1 <- var(machos)
n2 <- length(femeas)
v2 <- var(femeas)
(s.pond <- sqrt(((n1 - 1) * v1 + (n2 - 1) * v2)/(n1 + n2 - 2)))


t.test(x = machos, y = femeas, alternative = "greater",
       var.equal = TRUE)

mu0 <- 0

(tcalc <- (m1 - m2)/(s.pond * sqrt(1/n1 + 1/n2)))
(tcrit <- qt(.025, df = n1 + n2 - 2, lower.tail = FALSE))
pt(tcalc, df = n1 + n2 - 2, lower.tail = FALSE)

N <- 10000
## Usando a distribuicao amostral
am <- replicate(N, rnorm(1, 0, s.pond * sqrt(1/n1 + 1/n2)))
## Usando media dos machos
am <- replicate(N, diff(tapply(rnorm(20, m1, s.pond), da$sexo, mean)))
## Usando media das femeas
am <- replicate(N, diff(tapply(rnorm(20, m2, s.pond), da$sexo, mean)))

hist(am)
abline(v = med.amostral, col = 2)

format(sum(am >= med.amostral)/N, sci = FALSE)

## Padroniza a distribuição das propoções amostrais
tt <- (am - mu0)/(s.pond * sqrt(1/n1 + 1/n2))
hist(tt, freq = FALSE)
abline(v = tcalc, col = 2)

## Proporcao da amostra abaixo de theta0 ~ "p-valor"
sum(tt >= tcalc)/N

##----------------------------------------------------------------------
## Exemplo onde a diferenca nao eh tao grande
## Comparacao de duas medias - exemplo do Manly
set.seed(2)
machos <- c(120, 107, 110, 116, 114, 111, 113, 117, 114, 112)
femeas <- rnorm(10, mean(machos) - 2, sd = sd(machos))
da <- data.frame(comp = c(machos, femeas),
                 sexo = c(rep("M", 10), rep("F", 10)))
densityplot(~comp, groups = sexo, data = da, auto.key = TRUE)
tapply(da$comp, da$sexo, mean)
diff(tapply(da$comp, da$sexo, mean))

(m1 <- mean(machos))
(m2 <- mean(femeas))

(med.amostral <- m1 - m2)

n1 <- length(machos)
v1 <- var(machos)
n2 <- length(femeas)
v2 <- var(femeas)
(s.pond <- sqrt(((n1 - 1) * v1 + (n2 - 1) * v2)/(n1 + n2 - 2)))


t.test(x = machos, y = femeas, alternative = "greater",
       var.equal = TRUE)

t.test(x = machos, y = femeas, alternative = "greater",
       var.equal = TRUE)$statistic

mu0 <- 0

(tcalc <- (m1 - m2)/(s.pond * sqrt(1/n1 + 1/n2)))
(tcrit <- qt(.025, df = n1 + n2 - 2, lower.tail = FALSE))
pt(tcalc, df = n1 + n2 - 2, lower.tail = FALSE)

N <- 10000
am <- replicate(N, rnorm(1, 0, s.pond * sqrt(1/n1 + 1/n2)))
## Usando media dos machos
am <- replicate(N, diff(tapply(rnorm(20, m1, s.pond), da$sexo, mean)))
## Usando media das femeas
am <- replicate(N, diff(tapply(rnorm(20, m2, s.pond), da$sexo, mean)))

hist(am)
abline(v = med.amostral, col = 2)

sum(am >= med.amostral)/N

## Padroniza a distribuição das propoções amostrais
tt <- (am - mu0)/(s.pond * sqrt(1/n1 + 1/n2))
hist(tt, freq = FALSE)
abline(v = tcalc, col = 2)

## Proporcao da amostra abaixo de theta0 ~ "p-valor"
sum(tt >= tcalc)/N


##----------------------------------------------------------------------
## Exemplo do Walmes
set.seed(4)
da <- data.frame(local=gl(2, 30, labels=c("N","S")))
da$bico <- with(da, rnorm(length(local),
                          mean=49+2*as.integer(local),
                          sd=2))

densityplot(~bico, groups = local, data = da, auto.key = TRUE)
tapply(da$bico, da$local, mean)
diff(tapply(da$bico, da$local, mean))

(m1 <- mean(da$bico[da$local == "N"]))
(m2 <- mean(da$bico[da$local == "S"]))


(med.amostral <- m1 - m2)

n1 <- length(da$bico[da$local == "N"])
v1 <- var(da$bico[da$local == "N"])
n2 <- length(da$bico[da$local == "S"])
v2 <- var(da$bico[da$local == "S"])
(s.pond <- sqrt(((n1 - 1) * v1 + (n2 - 1) * v2)/(n1 + n2 - 2)))


t.test(bico ~ local, data = da, alternative = "less",
       var.equal = TRUE)

mu0 <- 0

(tcalc <- (m1 - m2)/(s.pond * sqrt(1/n1 + 1/n2)))
(tcrit <- qt(.025, df = n1 + n2 - 2, lower.tail = TRUE))
pt(tcalc, df = n1 + n2 - 2, lower.tail = TRUE)

N <- 10000
am <- replicate(N, rnorm(1, 0, s.pond * sqrt(1/n1 + 1/n2)))
## Usando media dos machos
am <- replicate(N, diff(tapply(rnorm(60, m1, s.pond), da$local, mean)))
## Usando media das femeas
am <- replicate(N, diff(tapply(rnorm(60, m2, s.pond), da$local, mean)))

hist(am)
abline(v = med.amostral, col = 2)

sum(am <= med.amostral)/N
sum(am < med.amostral)/N

## Padroniza a distribuição das propoções amostrais
tt <- (am - mu0)/(s.pond * sqrt(1/n1 + 1/n2))
hist(tt, freq = FALSE)
abline(v = tcalc, col = 2)

## Proporcao da amostra abaixo de theta0 ~ "p-valor"
sum(tt <= tcalc)/N
```

## Proporção

```{r, include=FALSE}
## Dados
n <- 250
y <- 32

## Proporção amostral
(theta.hat <- y/n)

## Teste de hipótese
## H0: theta = 0.15
## Ha: theta < 0.15
theta0 <- 0.15

## Estatistica de teste
(zcalc <- (theta.hat - theta0)/sqrt((theta0 * (1-theta0))/n))
## Com alpha = 0.05, o valor cítico é
(zcrit <- qnorm(.05))
ifelse(abs(zcalc) > abs(zcrit), "Rejeita H0", "Não rejeita H0")

## p-valor
pnorm(zcalc)
pbinom(y, size = n, prob = theta0) # teste exato
prop.test(x = 32, n = 250, p = 0.15, alternative = "less")
binom.test(x = 32, n = 250, p = 0.15, alternative = "less")


## Por simulação, sob theta0

## Gera k amostras com n = 250 e assumindo que theta0 é verdadeiro
set.seed(12)
k <- 10000
am <- rbinom(k, size = 250, prob = theta0)
am2 <- rnorm(k, mean = theta0, sd = sqrt((theta0 * (1 - theta0))/n))

par(mfrow = c(1, 3))
hist(am)
hist(am2)
## Proporção amostral
theta.hat.am <- am/n
hist(theta.hat.am)
par(mfrow = c(1, 1))

## Padroniza a distribuição das propoções amostrais
z <- (theta.hat.am - theta0)/sqrt((theta0 * (1-theta0))/n)
z <- (am2 - theta0)/sqrt((theta0 * (1-theta0))/n)
hist(z, freq = FALSE)
## Aproximação pela normal
curve(dnorm, -3, 3, add = TRUE, col = 2)
abline(v = zcalc, col = 2)

## Proporcao da amostra abaixo de theta0 ~ "p-valor"
sum(z <= zcalc)/k
sum(z < zcalc)/k

prop.test(x = 32, n = 250, p = 0.15, alternative = "less")
binom.test(x = 32, n = 250, p = 0.15, alternative = "less")
```


```{r}
## Lançamento de uma moeda.

## x <- scan()
## dput(x)

## Laçamento da moeda pelo Leonardo.
x <- c(1, 0, 0, 0, 0, 1, 1, 0, 0, 0, 1, 1, 1, 0, 0, 1, 0, 0, 0, 0,
       0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 1,
       1, 0, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 0,
       0, 1, 0, 1, 1, 0, 0, 0)

## Proporção amostral.
sum(x)/length(x)

## Número de trocas de face.
o <- sum(abs(diff(x))); o

## Laçamento de uma moeda verdadeira (p=0.5, lanç indep = sem memória)
sample(0:1, 70, replace=TRUE)
sum(abs(diff(sample(0:1, 70, replace=TRUE))))

## Função que lança uma moeda verdadeira e retorna o número de
## trocas. Ela reproduz o experimento sob a hipótese nula, ou seja, com
## p=0.5 e lançamentos independentes (sem memória).

moeda <- function(n){
    ## sum(abs(diff(rbinom(n, 1, 0.5))))
    sum(abs(diff(sample(0:1, n, replace=TRUE))))
}

moeda(70)

## Faz várias execuções do experimento aleatório.
r <- replicate(100000, moeda(70))

## A distribuição amostral da estatística número de trocas.
hist(r, breaks=seq(min(r), max(r)+1, by=1)-0.5, prob=TRUE,
     xlab="Número de trocas em 70 lançamentos",
     ylab="Densidade", main=NULL)
abline(v=o, col=2)
text(x=o, y=par()$usr[4], label="Estatística observada", srt=90,
     adj=c(1.25,-0.25))

plot(ecdf(r))
abline(v=o, col=2)
text(x=o, y=par()$usr[4], label="Estatística observada", srt=90,
     adj=c(1.25,-0.25))

## Como a v.a. é discreta.
sum(r<=o)/length(r)
sum(r<o)/length(r)

pbinom(o, 70, prob = 0.5)
prop.test(x = 27, n = 70, alternative = "less")
binom.test(x = 27, n = 70, alternative = "less")

2 * sum(r<=o)/length(r)
2 * sum(r<o)/length(r)
prop.test(x = 27, n = 70, alternative = "two.sided")
binom.test(x = 27, n = 70, alternative = "two.sided")

## A distribuição do número de trocas sob H0 é uma Binomial.
i <- 0:69
p <- pbinom(i, size=69, p=0.5)

plot(ecdf(r), verticals=TRUE, cex=NA, main=NULL,
     xlab="Número de trocas em 70 lançamentos",
     ylab="Probabilidade acumulada")
lines(p~i, type="s", col=2)
legend("right",
       legend=c("Distribuição empírica", "Distribuição teórica"),
       col=1:2, lty=1, bty="n")
```
